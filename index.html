<!doctype html><html lang="ru"><head><meta charset="utf-8"/><meta http-equiv="Content-Security-Policy" content="default-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; script-src 'self' 'unsafe-inline';"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vegan Recipe Builder Pro ¬∑ v1.6 BigTech</title>
<style>
:root{
  --bg: #0b0f14; --bg2:#0e1520; --surface: rgba(255,255,255,.05); --line:#1f2b3a;
  --fg:#e6edf3; --mut:#a6b0bf; --brand:#7c3aed; --brand2:#22c55e; --accent:#0ea5e9; --danger:#ef4444;
  --radius:16px; --shadow:0 12px 40px rgba(0,0,0,.35);
}
[data-theme="light"]{ --bg:#f7f8fa; --bg2:#ffffff; --surface: rgba(0,0,0,.04); --line:#e5e7eb; --fg:#0b1320; --mut:#5b6675; }
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:linear-gradient(135deg,var(--bg),var(--bg2));color:var(--fg);font:14px/1.5 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,-apple-system,sans-serif}
.container{max-width:1240px;margin:0 auto;padding:0 20px}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(6,10,16,.85),rgba(6,10,16,.65));backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
[data-theme="light"] header{background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.65))}
.hrow{display:flex;align-items:center;gap:14px;justify-content:space-between;padding:14px 0}
.brand{display:flex;align-items:center;gap:10px}
.brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 0 0 3px rgba(124,58,237,.25)}
.h1{font-size:18px;margin:0}
.sub{color:var(--mut);font-size:12px}
.tabbar{display:flex;gap:8px;flex-wrap:wrap}
.tab{border:1px solid var(--line);background:var(--surface);color:var(--fg);padding:8px 12px;border-radius:12px;cursor:pointer}
.tab.active{background:linear-gradient(135deg,rgba(124,58,237,.18),rgba(34,197,94,.18));border-color:#334155}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:1px solid var(--line);background:var(--surface);color:var(--fg);padding:8px 12px;border-radius:12px;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));border:none;color:#020611}
.btn.danger{background:rgba(239,68,68,.12);border-color:#3f1f25;color:#fecaca}
.btn.icon{display:inline-flex;align-items:center;gap:8px}

.hero{padding:16px 0;border-bottom:1px solid var(--line);background:linear-gradient(135deg,rgba(124,58,237,.08),transparent)}
.hero .grid{display:grid;grid-template-columns:1.4fr .6fr;gap:14px}
.card{background:linear-gradient(180deg,var(--surface),transparent);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}

.grid2{display:grid;grid-template-columns:340px 1fr;gap:16px;margin-top:16px}
label{display:block;margin:8px 0 4px;color:var(--mut)}
input,select,textarea{width:100%;background:rgba(255,255,255,.04);color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:10px}
input[type="checkbox"],input[type="file"]{width:auto}
.small{font-size:12px;color:var(--mut)}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .pill{background:var(--surface);border:1px solid var(--line);padding:10px 12px;border-radius:14px;min-width:120px}
.kpi .pill strong{font-size:16px}
.tbl{width:100%;border-collapse:collapse}
.tbl th,.tbl td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
.tbl th{color:var(--mut)}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.cardR{display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,var(--surface),transparent);border:1px solid var(--line);border-radius:16px;padding:12px;transition:transform .12s ease}
.cardR:hover{transform:translateY(-2px)}
.cardR img{width:100%;height:160px;object-fit:cover;border-radius:12px;border:1px solid var(--line)}
.empty{padding:14px;border:1px dashed #334155;border-radius:12px;color:var(--mut);text-align:center}
.toast{position:fixed;right:18px;bottom:18px;background:#0b1320;border:1px solid #223047;color:#c6d0df;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.3);opacity:0;transform:translateY(10px);transition:.2s}
.toast.show{opacity:1;transform:translateY(0)}
.switch{display:inline-flex;align-items:center;gap:8px}
.switch input{display:none}
.switch .knob{width:44px;height:24px;background:var(--surface);border:1px solid var(--line);border-radius:999px;position:relative}
.switch .knob:after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));transition:.18s}
.switch input:checked + .knob:after{left:24px}
.mono{font-family:ui-monospace, Menlo, Consolas, monospace}
hr.sep{border:none;border-top:1px solid var(--line);margin:12px 0}
</style>
</head>
<body>
<header>
  <div class="container hrow">
    <div class="brand"><div class="dot"></div>
      <div>
        <div class="h1">Vegan Recipe Builder Pro <span class="small">¬∑ Desktop</span></div>
        <div class="sub">Electron ¬∑ IndexedDB ¬∑ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä ¬∑ –ì–∞–ª–µ—Ä–µ—è ¬∑ –ê–¥–º–∏–Ω ¬∑ Preset Packs</div>
      </div>
    </div>
    <div class="tabbar">
      <button class="tab active" data-tab="builder">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
      <button class="tab" data-tab="recipes">–†–µ—Ü–µ–ø—Ç—ã</button>
      <button class="tab" data-tab="admin">–ê–¥–º–∏–Ω</button>
    </div>
    <div class="actions">
      <label class="switch small"><input id="theme" type="checkbox"><span class="knob"></span>–¢–µ–º–∞</label>
      <button id="btnRandom" class="btn icon">üé≤ –°–ª—É—á–∞–π–Ω—ã–π</button>
      <button id="btnCopy" class="btn icon">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button id="btnExport" class="btn icon">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <button id="btnPrint" class="btn icon">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
    </div>
  </div>
</header>
<section class="hero">
  <div class="container grid">
    <div class="card"><strong>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è</strong>
      <div class="small">1) –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –≤ ¬´–ê–¥–º–∏–Ω¬ª. 2) –°–æ–±–µ—Ä–∏—Ç–µ —Ä–µ—Ü–µ–ø—Ç –≤ ¬´–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä¬ª. 3) –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ –Ω–∞–π–¥–∏—Ç–µ –µ–≥–æ –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–†–µ—Ü–µ–ø—Ç—ã¬ª. –ü–∞–∫–µ—Ç—ã –ø—Ä–µ—Å–µ—Ç–æ–≤ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–¥–Ω–∏–º JSON.</div>
    </div>
    <div class="card"><strong>–§–∏–ª—å—Ç—Ä—ã</strong>
      <div class="small">–í–µ–≥–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤, –ø–∞—Å–ª—ë–Ω–æ–≤ –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤—ã–∫–ª—é—á–∞—Ç–µ–ª—å –±–∞–∫–ª–∞–∂–∞–Ω–∞.</div>
    </div>
  </div>
</section>

<div class="container" style="padding:14px 0 28px">
  <!-- BUILDER TAB -->
  <section id="tab_builder">
    <div class="grid2">
      <aside class="card">
        <label>–ü–æ—Ä—Ü–∏–π</label><input id="servings" type="number" value="2" min="1"/>
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="category"><option value="all">–í—Å–µ</option><option value="grain">–ó–µ—Ä–Ω–æ/–æ—Å–Ω–æ–≤–∞</option><option value="protein">–ë–µ–ª–æ–∫</option><option value="veg">–û–≤–æ—â–∏</option><option value="greens">–ó–µ–ª–µ–Ω—å</option><option value="sauce">–°–æ—É—Å/–º–∞—Å–ª–∞</option><option value="spice">–°–ø–µ—Ü–∏–∏</option></select>
        <label>–ü–æ–∏—Å–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞</label><input id="search" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –Ω—É—Ç, –∫–∏–Ω–æ–∞, —Ç–∞—Ö–∏–Ω–∏"/>
        <label>–ê–ª–ª–µ—Ä–≥–∏–∏/–∏—Å–∫–ª—é—á–µ–Ω–∏—è</label>
        <div class="toolbar">
          <label class="small"><input type="checkbox" id="f_gluten"> –ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞</label>
          <label class="small"><input type="checkbox" id="f_soy"> –ë–µ–∑ —Å–æ–∏</label>
          <label class="small"><input type="checkbox" id="f_nuts"> –ë–µ–∑ –æ—Ä–µ—Ö–æ–≤</label>
          <label class="small"><input type="checkbox" id="f_night"> –ë–µ–∑ –ø–∞—Å–ª—ë–Ω–æ–≤</label>
          <label class="small"><input type="checkbox" id="f_no_eggplant" checked> –ë–µ–∑ –±–∞–∫–ª–∞–∂–∞–Ω–∞</label>
        </div>
        <label>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</label>
        <select id="ingSelect"></select>
        <div class="toolbar"><input id="qty" type="number" min="1" value="100" style="max-width:120px"><button id="add" class="btn primary">–î–æ–±–∞–≤–∏—Ç—å</button></div>
        <div class="small">–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —Å–ø–∏—Å–∫—É –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–µ—Ç 100 –≥.</div>
        <hr class="sep"/>
        <label>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —Ä–µ—Ü–µ–ø—Ç</label>
        <div class="toolbar"><input id="recipeName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë–æ—É–ª —Å –Ω—É—Ç–æ–º" style="flex:1"><button id="saveRecipe" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
      </aside>
      <main class="card">
        <div class="kpi">
          <div class="pill"><div class="small">–ö–∫–∞–ª / —Ä–µ—Ü–µ–ø—Ç</div><strong id="kcalT">0</strong></div>
          <div class="pill"><div class="small">–ë–µ–ª–æ–∫, –≥</div><strong id="protT">0</strong></div>
          <div class="pill"><div class="small">–ñ–∏—Ä—ã, –≥</div><strong id="fatT">0</strong></div>
          <div class="pill"><div class="small">–£–≥–ª–µ–≤–æ–¥—ã, –≥</div><strong id="carbT">0</strong></div>
          <div class="pill"><div class="small">–°—Ç–æ–∏–º–æ—Å—Ç—å, ‚Ç™</div><strong id="costT">0.00</strong></div>
          <div class="pill"><div class="small">–ù–∞ –ø–æ—Ä—Ü–∏—é</div><strong id="perServe">0 –∫–∫–∞–ª</strong></div>
        </div>
        <hr class="sep"/>
        <h3 style="margin:0 0 8px">–°–æ—Å—Ç–∞–≤</h3>
        <table class="tbl" id="table"><thead><tr><th>–ò–Ω–≥—Ä.</th><th class="small">–ö–∞—Ç.</th><th>–≥</th><th>–ö–∫–∞–ª</th><th>–ë</th><th>–ñ</th><th>–£</th><th>‚Ç™</th><th></th></tr></thead><tbody></tbody></table>
        <hr class="sep"/>
        <div class="toolbar"><button id="btnSteps" class="btn">üß™ –®–∞–≥–∏</button><button id="btnClear" class="btn danger">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
        <label>–®–∞–≥–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</label>
        <textarea id="steps" rows="5" placeholder="–®–∞–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å‚Ä¶"></textarea>
        <div class="small">–®–∞–≥–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –æ—Ñ–ª–∞–π–Ω –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤.</div>
      </main>
    </div>
  </section>

  <!-- RECIPES TAB -->
  <section id="tab_recipes" style="display:none">
    <div class="card">
      <div class="toolbar"><input id="qRecipes" placeholder="–ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/—Ç–µ–≥–∞–º" style="flex:1"><button id="exportDb" class="btn">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–π –ë–î</button></div>
      <div id="recipesList" class="gallery"></div>
      <div id="recipesEmpty" class="empty" style="display:none">–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ä–µ—Ü–µ–ø—Ç—ã –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î. –ó–∞–π–¥–∏—Ç–µ –≤ ¬´–ê–¥–º–∏–Ω¬ª, —á—Ç–æ–±—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ä–µ—Ü–µ–ø—Ç.</div>
    </div>
  </section>

  <!-- ADMIN TAB -->
  <section id="tab_admin" style="display:none">
    <div class="grid2" style="grid-template-columns:1fr 1fr">
      <div class="card">
        <h3 style="margin:0 0 8px">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (IndexedDB)</h3>
        <label>–î–æ–±–∞–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å</label>
        <div class="toolbar"><input id="ingName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ö–∏–Ω–æ–∞)" style="flex:1"><select id="ingCat"><option value="grain">–ó–µ—Ä–Ω–æ</option><option value="protein">–ë–µ–ª–æ–∫</option><option value="veg">–û–≤–æ—â</option><option value="greens">–ó–µ–ª–µ–Ω—å</option><option value="sauce">–°–æ—É—Å</option><option value="spice">–°–ø–µ—Ü–∏–∏</option></select></div>
        <div class="grid2" style="grid-template-columns:repeat(4,1fr)">
          <input id="kcal" type="number" step="1" placeholder="–ö–∫–∞–ª/100–≥"><input id="prot" type="number" step="0.1" placeholder="–ë/100–≥"><input id="fat" type="number" step="0.1" placeholder="–ñ/100–≥"><input id="carb" type="number" step="0.1" placeholder="–£/100–≥">
        </div>
        <div class="toolbar"><input id="price" type="number" step="0.01" placeholder="‚Ç™/100–≥"><input id="fdc" class="mono" placeholder="FDC ID –∏–ª–∏ –∑–∞–ø—Ä–æ—Å (quinoa cooked)"></div>
        <div class="toolbar small">
          <label><input type="checkbox" id="flag_gluten"> –≥–ª—é—Ç–µ–Ω</label>
          <label><input type="checkbox" id="flag_soy"> —Å–æ—è</label>
          <label><input type="checkbox" id="flag_nuts"> –æ—Ä–µ—Ö–∏/—Å–µ–º–µ–Ω–∞</label>
          <label><input type="checkbox" id="flag_night"> –ø–∞—Å–ª—ë–Ω—ã</label>
          <label><input type="checkbox" id="flag_eggplant"> –±–∞–∫–ª–∞–∂–∞–Ω</label>
        </div>
        <div class="toolbar"><button id="saveIng" class="btn primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</button><button id="deleteIng" class="btn danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ –∏–º–µ–Ω–∏</button></div>
        <hr class="sep"/>
        <label>–ò–º–ø–æ—Ä—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (JSON)</label>
        <textarea id="importIng" rows="5" class="mono" placeholder='[{"name":"–ö–∏–Ω–æ–∞","cat":"grain","per100":{"k":120,"p":4.4,"f":1.9,"c":21.3,"price":2.2},"flags":{"gluten":false,"soy":false,"nuts":false}}]'></textarea>
        <div class="toolbar"><button id="btnImportIng" class="btn">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button><button id="btnClearIng" class="btn danger">–û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">–†–µ—Ü–µ–ø—Ç—ã (IndexedDB)</h3>
        <div class="toolbar"><input id="rName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞" style="flex:1"><input id="rServ" type="number" min="1" value="2" style="max-width:120px"></div>
        <input id="rTags" placeholder="–¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–±–æ—É–ª,–±–µ–∑–≥–ª—é—Ç)">
        <textarea id="rSteps" rows="4" placeholder="–®–∞–≥–∏‚Ä¶"></textarea>
        <div class="toolbar"><input id="rImage" type="file" accept="image/*"><button id="btnAddItem" class="btn">+ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –∏–∑ –ë–î</button><button id="btnSaveRecipe" class="btn primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç</button><button id="btnDelRecipe" class="btn danger">–£–¥–∞–ª–∏—Ç—å</button></div>
        <div class="empty" id="rItemsBox">–°–æ—Å—Ç–∞–≤ —Ä–µ—Ü–µ–ø—Ç–∞: –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏—Ç–µ ¬´+ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –∏–∑ –ë–î¬ª.</div>
        <hr class="sep"/>
        <h3 style="margin:8px 0">–ü–∞–∫–µ—Ç—ã –ø—Ä–µ—Å–µ—Ç–æ–≤</h3>
        <div class="small">–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON —Å <span class="mono">{ingredients:[‚Ä¶], recipes:[‚Ä¶]}</span>. –§–∞–π–ª—ã –º–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å.</div>
        <div class="toolbar"><input id="packFile" type="file" accept="application/json"><button id="btnImportPack" class="btn">–ò–º–ø–æ—Ä—Ç –ø–∞–∫–µ—Ç–∞</button><button id="btnExportDB" class="btn">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ–π –ë–î</button><button id="btnResetDB" class="btn danger">–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ë–î</button></div>
      </div>
    </div>
  </section>
</div>
<div class="toast" id="toast"></div>
<script>
(function(){
  const $=s=>document.querySelector(s), byId=id=>document.getElementById(id);
  const fmt=(x,d=0)=>Number(x||0).toFixed(d); const slug=s=>String(s||'').toLowerCase().replace(/[^a-z–∞-—è0-9]+/gi,'-').replace(/(^-|-$)/g,'');
  // theme
  const themeKey='vrb_theme'; const savedTheme=localStorage.getItem(themeKey)||'dark'; if(savedTheme==='light'){document.documentElement.setAttribute('data-theme','light'); byId('theme').checked=true}
  byId('theme').addEventListener('change',()=>{ const t=byId('theme').checked?'light':'dark'; document.documentElement.setAttribute('data-theme', t==='light'?'light':''); localStorage.setItem(themeKey,t); });

  // ---- IndexedDB wrapper ----
  const DB_NAME='veganDB'; const DB_VERSION=1; let _db=null;
  function openDB(){return new Promise((res,rej)=>{ if(_db) return res(_db); const rq=indexedDB.open(DB_NAME,DB_VERSION); rq.onupgradeneeded=()=>{const db=rq.result; if(!db.objectStoreNames.contains('ingredients')) db.createObjectStore('ingredients',{keyPath:'id'}); if(!db.objectStoreNames.contains('recipes')) db.createObjectStore('recipes',{keyPath:'id'});}; rq.onsuccess=()=>{_db=rq.result; res(_db)}; rq.onerror=()=>rej(rq.error)});}  
  const idbAll=(store)=>openDB().then(db=>new Promise((res,rej)=>{const tx=db.transaction(store,'readonly'); const st=tx.objectStore(store); const rq=st.getAll(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=()=>rej(rq.error)}));
  const idbPut=(store,obj)=>openDB().then(db=>new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite'); tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error); tx.objectStore(store).put(obj)}));
  const idbDel=(store,key)=>openDB().then(db=>new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite'); tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error); tx.objectStore(store).delete(key)}));
  const idbClear=(store)=>openDB().then(db=>new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite'); tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error); tx.objectStore(store).clear()}));

  const state={items:[], servings:2, ingCache:[], recCache:[]};
  function toast(msg){const t=byId('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500)}

  // tabs
  document.querySelectorAll('.tabbar .tab').forEach(b=>b.addEventListener('click',()=>{
    document.querySelectorAll('.tabbar .tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
    const tab=b.dataset.tab; ['builder','recipes','admin'].forEach(k=> byId('tab_'+k).style.display = (k===tab)?'block':'none');
  }));

  // ingredients helpers
  async function refreshIngCache(){ state.ingCache=await idbAll('ingredients'); refreshIngSelect(); }
  function findIngById(id){ return state.ingCache.find(x=>x.id===id) }
  function findIngByName(name){ name=(name||'').trim().toLowerCase(); return state.ingCache.find(x=>x.name.toLowerCase()===name) }
  function flagsOK(x,f){ if(f.no_eggplant && x.flags?.eggplant) return false; if(f.no_night && x.flags?.night) return false; if(f.gf && x.flags?.gluten) return false; if(f.no_soy && x.flags?.soy) return false; if(f.no_nuts && x.flags?.nuts) return false; return true }
  function filters(){ return { gf: byId('f_gluten').checked, no_soy: byId('f_soy').checked, no_nuts: byId('f_nuts').checked, no_night: byId('f_night').checked, no_eggplant: byId('f_no_eggplant').checked } }
  function refreshIngSelect(){ const cat=byId('category').value; const q=(byId('search').value||'').toLowerCase().trim(); const f=filters(); const sel=byId('ingSelect'); sel.innerHTML=''; state.ingCache.filter(x=> (cat==='all'||x.cat===cat) && (!q||x.name.toLowerCase().includes(q)) && flagsOK(x,f)).forEach(x=>{ const o=document.createElement('option'); o.value=x.id; o.textContent=`${x.name} ¬∑ ${x.cat}`; sel.appendChild(o) }); }

  // builder
  function addSelected(){ const id=byId('ingSelect').value; if(!id) return; const qty=Math.max(1,Math.round(Number(byId('qty').value||0))); state.items.push({id,qty}); renderTable(); }
  function removeIdx(i){ state.items.splice(i,1); renderTable(); }
  function totals(){ let k=0,p=0,f=0,c=0,cost=0; state.items.forEach(it=>{ const ing=findIngById(it.id); if(!ing) return; const m=it.qty/100; k+= (ing.per100?.k||0)*m; p+=(ing.per100?.p||0)*m; f+=(ing.per100?.f||0)*m; c+=(ing.per100?.c||0)*m; cost+= (ing.per100?.price||0)*m; }); return {k,p,f,c,cost}; }
  function renderTable(){ const tb=document.querySelector('#table tbody'); tb.innerHTML=''; state.items.forEach((it,i)=>{ const ing=findIngById(it.id); if(!ing) return; const m=it.qty/100; const tr=document.createElement('tr'); tr.innerHTML=`<td>${ing.name}</td><td class="small">${ing.cat}</td><td>${it.qty}</td><td>${fmt(ing.per100.k*m)}</td><td>${fmt(ing.per100.p*m,1)}</td><td>${fmt(ing.per100.f*m,1)}</td><td>${fmt(ing.per100.c*m,1)}</td><td>${fmt((ing.per100.price||0)*m,2)}</td><td><button data-i="${i}" class="btn danger" style="padding:4px 8px">‚úñ</button></td>`; tb.appendChild(tr); }); tb.querySelectorAll('button').forEach(b=>b.addEventListener('click',e=>removeIdx(Number(e.target.getAttribute('data-i'))))); updateKPI(); }
  function updateKPI(){ const t=totals(); const s=Math.max(1,Number(byId('servings').value||1)); state.servings=s; byId('kcalT').textContent=fmt(t.k); byId('protT').textContent=fmt(t.p,1); byId('fatT').textContent=fmt(t.f,1); byId('carbT').textContent=fmt(t.c,1); byId('costT').textContent=fmt(t.cost,2); byId('perServe').textContent=`${fmt(t.k/s)} –∫–∫–∞–ª`; }
  function genSteps(){ const have=cat=>state.items.some(it=>findIngById(it.id)?.cat===cat); const txt=[]; if(have('grain')) txt.push('1) –û—Ç–≤–∞—Ä–∏—Ç—å –æ—Å–Ω–æ–≤—É (1:2 –≤–æ–¥–∞), 12‚Äì15 –º–∏–Ω.'); if(have('veg')) txt.push('2) –û–≤–æ—â–∏: –∑–∞–ø–µ—á—å 15‚Äì20 –º–∏–Ω –ø—Ä–∏ 200¬∞C –∏–ª–∏ –æ–±–∂–∞—Ä–∏—Ç—å 6‚Äì8 –º–∏–Ω.'); if(have('protein')) txt.push('3) –ë–µ–ª–æ–∫: –æ—Ç–≤–∞—Ä–∏—Ç—å –±–æ–±–æ–≤—ã–µ –¥–æ –º—è–≥–∫–æ—Å—Ç–∏ –∏–ª–∏ –ø—Ä–æ–≥—Ä–µ—Ç—å —Ç–æ—Ñ—É/—Å–µ–π—Ç–∞–Ω 3‚Äì4 –º–∏–Ω.'); if(have('sauce')) txt.push('4) –°–æ—É—Å: —Å–º–µ—à–∞—Ç—å —Ç–∞—Ö–∏–Ω–∏/–º–∞—Å–ª–æ —Å –ª–∏–º–æ–Ω–æ–º, –≤–æ–¥–æ–π, —Å–ø–µ—Ü–∏—è–º–∏.'); if(have('greens')) txt.push('5) –ó–µ–ª–µ–Ω—å: –Ω–∞—Ä–µ–∑–∞—Ç—å, –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ –ø–æ–¥–∞—á–µ–π.'); txt.push('6) –°–æ–±—Ä–∞—Ç—å: –æ—Å–Ω–æ–≤–∞ ‚Üí –æ–≤–æ—â–∏ ‚Üí –±–µ–ª–æ–∫ ‚Üí —Å–æ—É—Å ‚Üí –∑–µ–ª–µ–Ω—å.'); byId('steps').value=txt.join('\n'); }
  function copyText(){ const t=totals(); const lines=[`# –†–µ—Ü–µ–ø—Ç –Ω–∞ ${state.servings} –ø–æ—Ä—Ü–∏–∏`]; state.items.forEach(it=>{ const ing=findIngById(it.id); lines.push(`- ${ing?.name}: ${it.qty} –≥`)}); lines.push(`–ò—Ç–æ–≥–æ: ${fmt(t.k)} –∫–∫–∞–ª; –ë:${fmt(t.p,1)} –ñ:${fmt(t.f,1)} –£:${fmt(t.c,1)}; ‚âà ‚Ç™${fmt(t.cost,2)}`); if(byId('steps').value.trim()) lines.push('\n–®–∞–≥–∏:\n'+byId('steps').value.trim()); navigator.clipboard.writeText(lines.join('\n')).then(()=>toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')).catch(()=>toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å')); }
  function exportJSON(){ const payload={ts:new Date().toISOString(), servings:state.servings, items:state.items.map(it=>({id:it.id,name:findIngById(it.id)?.name,qty:it.qty})), totals:totals(), steps:byId('steps').value}; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'})); a.download=`vegan_recipe_${Date.now()}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); }
  function printPage(){ window.print(); }
  async function saveRecipeFromBuilder(){ const name=(byId('recipeName').value||'').trim(); if(!name){ toast('–ò–º—è —Ä–µ—Ü–µ–ø—Ç–∞'); return } const id='rec-'+slug(name); const rec={ id, name, servings:state.servings, items:state.items, steps:byId('steps').value, tags:[], image:null, createdAt:Date.now(), updatedAt:Date.now() }; await idbPut('recipes',rec); toast('–†–µ—Ü–µ–ø—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ë–î'); await refreshRecCache(); }

  // recipes gallery
  async function refreshRecCache(){ state.recCache=await idbAll('recipes'); renderRecipes(); }
  function renderRecipes(){ const list=$('#recipesList'); const empty=$('#recipesEmpty'); const q=(byId('qRecipes').value||'').toLowerCase().trim(); const arr=state.recCache.filter(r=>!q||r.name.toLowerCase().includes(q)|| (r.tags||[]).join(',').toLowerCase().includes(q)); list.innerHTML=''; if(!arr.length){ empty.style.display='block'; return } empty.style.display='none'; arr.sort((a,b)=>b.updatedAt-a.updatedAt).forEach(r=>{ const it=document.createElement('div'); it.className='cardR'; it.innerHTML=`<img src="${r.image||'data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'200\'><rect width=\'100%\' height=\'100%\' fill=\'%230b1220\'/><text x=\'50%\' y=\'50%\' fill=\'%239aa4b2\' font-size=\'18\' text-anchor=\'middle\' dy=\'.3em\'>–§–æ—Ç–æ —Ä–µ—Ü–µ–ø—Ç–∞</text></svg>'}" alt="">`+
        `<div><strong>${r.name}</strong></div>`+
        `<div class="small">–ü–æ—Ä—Ü–∏–∏: ${r.servings} ${r.tags?.length? '¬∑ '+r.tags.map(t=>`<span class=\'tag\'>${t}</span>`).join(''):''}</div>`+
        `<div class="toolbar"><button class="btn" data-load="${r.id}">–û—Ç–∫—Ä—ã—Ç—å</button><button class="btn danger" data-del="${r.id}">–£–¥–∞–ª–∏—Ç—å</button></div>`; list.appendChild(it); });
    list.querySelectorAll('button[data-load]').forEach(b=>b.addEventListener('click',e=>loadRecipeToBuilder(e.target.getAttribute('data-load'))));
    list.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click',async e=>{ await idbDel('recipes', e.target.getAttribute('data-del')); toast('–£–¥–∞–ª–µ–Ω–æ'); refreshRecCache(); })); }
  async function loadRecipeToBuilder(id){ const r=state.recCache.find(x=>x.id===id); if(!r) return; state.items=[...(r.items||[])]; byId('servings').value=r.servings||2; byId('steps').value=r.steps||''; document.querySelector('[data-tab="builder"]').click(); renderTable(); toast('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä'); }

  // admin: ingredients
  async function saveIngredient(){ const name=(byId('ingName').value||'').trim(); if(!name){ toast('–ò–º—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞'); return } const obj={ id:'ing-'+slug(name), name, cat: byId('ingCat').value, per100:{k:Number(byId('kcal').value||0), p:Number(byId('prot').value||0), f:Number(byId('fat').value||0), c:Number(byId('carb').value||0), price:Number(byId('price').value||0)}, flags:{gluten:byId('flag_gluten').checked, soy:byId('flag_soy').checked, nuts:byId('flag_nuts').checked, night:byId('flag_night').checked, eggplant:byId('flag_eggplant').checked}, fdc: (byId('fdc').value||'').trim() };
    await idbPut('ingredients',obj); toast('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); await refreshIngCache(); }
  async function deleteIngredient(){ const name=(byId('ingName').value||'').trim(); if(!name){ toast('–ò–º—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è'); return } await idbDel('ingredients','ing-'+slug(name)); toast('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç —É–¥–∞–ª—ë–Ω'); await refreshIngCache(); }
  async function importIngredients(){ try{ const arr=JSON.parse(byId('importIng').value||'[]'); for(const it of arr){ if(!it.name) continue; const obj={ id:it.id||('ing-'+slug(it.name)), name:it.name, cat: it.cat||'veg', per100:it.per100||{k:0,p:0,f:0,c:0,price:0}, flags:it.flags||{}, fdc: it.fdc||'' }; await idbPut('ingredients',obj);} toast('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã'); await refreshIngCache(); }catch(e){ toast('–û—à–∏–±–∫–∞ JSON –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤') } }
  async function clearIngredients(){ await idbClear('ingredients'); toast('–¢–∞–±–ª–∏—Ü–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –æ—á–∏—â–µ–Ω–∞'); await refreshIngCache(); }

  // admin: recipes + packs
  let rItems=[]; function renderRItems(){ const box=byId('rItemsBox'); if(!rItems.length){ box.className='empty'; box.textContent='–°–æ—Å—Ç–∞–≤ —Ä–µ—Ü–µ–ø—Ç–∞: –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏—Ç–µ ¬´+ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –∏–∑ –ë–î¬ª.'; return } box.className='card'; box.innerHTML=''; rItems.forEach((it,i)=>{ const row=document.createElement('div'); row.className='toolbar'; const ing=findIngByName(it.name)||findIngById(it.id)||{}; row.innerHTML=`<div style="flex:1">${ing.name||it.name}</div><input data-i="${i}" class="riQty" type="number" value="${it.qty||100}" min="1" style="max-width:120px"><button data-del="${i}" class="btn danger">‚úñ</button>`; box.appendChild(row); }); box.querySelectorAll('.riQty').forEach(inp=>inp.addEventListener('input',e=>{ rItems[Number(e.target.dataset.i)].qty=Math.max(1,Number(e.target.value||1)); })); box.querySelectorAll('button[data-del]').forEach(btn=>btn.addEventListener('click',e=>{ rItems.splice(Number(e.target.getAttribute('data-del')),1); renderRItems(); })); }
  async function addItemFromDB(){ if(!state.ingCache.length){ toast('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã'); return } const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ (–∫–∞–∫ –≤ –ë–î)'); if(!name) return; const ing=findIngByName(name); if(!ing){ toast('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ë–î'); return } rItems.push({id:ing.id,name:ing.name,qty:100}); renderRItems(); }
  async function saveRecipeAdmin(){ const name=(byId('rName').value||'').trim(); if(!name){ toast('–ò–º—è —Ä–µ—Ü–µ–ø—Ç–∞'); return } const id='rec-'+slug(name); const tags=(byId('rTags').value||'').split(',').map(s=>s.trim()).filter(Boolean); const servings=Math.max(1,Number(byId('rServ').value||1)); const steps=byId('rSteps').value||''; let image=null; const f=byId('rImage').files[0]; if(f){ image= await fileToDataURL(f); }
    const rec={id,name,servings,items:rItems.map(x=>({id:x.id,name:x.name,qty:Number(x.qty||100)})),steps,tags,image,createdAt:Date.now(),updatedAt:Date.now()}; await idbPut('recipes',rec); toast('–†–µ—Ü–µ–ø—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); rItems=[]; renderRItems(); await refreshRecCache(); }
  async function delRecipeAdmin(){ const name=(byId('rName').value||'').trim(); if(!name){ toast('–ò–º—è —Ä–µ—Ü–µ–ø—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è'); return } await idbDel('recipes','rec-'+slug(name)); toast('–†–µ—Ü–µ–ø—Ç —É–¥–∞–ª—ë–Ω'); await refreshRecCache(); }
  async function importRecipes(){ try{ const arr=JSON.parse(byId('importRec').value||'[]'); for(const r of arr){ if(!r.name) continue; const rec={ id:r.id||('rec-'+slug(r.name)), name:r.name, servings:r.servings||2, items:(r.items||[]).map(x=>({id:x.id||('ing-'+slug(x.name)), name:x.name, qty:Number(x.qty||100)})), steps:r.steps||'', tags:r.tags||[], image:r.image||null, createdAt:Date.now(), updatedAt:Date.now()}; await idbPut('recipes',rec);} toast('–†–µ—Ü–µ–ø—Ç—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã'); await refreshRecCache(); }catch(e){ toast('–û—à–∏–±–∫–∞ JSON —Ä–µ—Ü–µ–ø—Ç–æ–≤') } }
  async function clearRecipes(){ await idbClear('recipes'); toast('–¢–∞–±–ª–∏—Ü–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –æ—á–∏—â–µ–Ω–∞'); await refreshRecCache(); }
  async function exportDB(){ const ings=await idbAll('ingredients'); const recs=await idbAll('recipes'); const data={ingredients:ings, recipes:recs, ts:new Date().toISOString()}; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); a.download=`veganDB_${Date.now()}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); }
  async function resetDB(){ await clearIngredients(); await clearRecipes(); toast('–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω'); }
  function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

  // packs
  async function importPackFile(){ const f=byId('packFile').files[0]; if(!f){ toast('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ø–∞–∫–µ—Ç–∞'); return } const txt=await f.text(); try{ const pack=JSON.parse(txt); const ings=pack.ingredients||[]; const recs=pack.recipes||[]; for(const it of ings){ if(!it.name) continue; await idbPut('ingredients',{ id:it.id||('ing-'+slug(it.name)), name:it.name, cat:it.cat||'veg', per100:it.per100||{k:0,p:0,f:0,c:0,price:0}, flags:it.flags||{}, fdc:it.fdc||'' }); }
      for(const r of recs){ if(!r.name) continue; await idbPut('recipes',{ id:r.id||('rec-'+slug(r.name)), name:r.name, servings:r.servings||2, items:(r.items||[]).map(x=>({id:x.id||('ing-'+slug(x.name)), name:x.name, qty:Number(x.qty||100)})), steps:r.steps||'', tags:r.tags||[], image:r.image||null, createdAt:Date.now(), updatedAt:Date.now()}); }
      toast(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${ings.length} –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤, ${recs.length} —Ä–µ—Ü–µ–ø—Ç–æ–≤`); await refreshIngCache(); await refreshRecCache();
    }catch(e){ toast('–û—à–∏–±–∫–∞ JSON –ø–∞–∫–µ—Ç–∞') }
  }

  // random recipe from DB
  function randomRecipe(){ state.items=[]; const f=filters(); const pick=cat=>{ const pool=state.ingCache.filter(x=>x.cat===cat && flagsOK(x,f)); if(!pool.length) return null; return pool[Math.floor(Math.random()*pool.length)]}; const base=pick('grain')||pick('veg'); if(base) state.items.push({id:base.id,qty:180}); const prot=pick('protein'); if(prot) state.items.push({id:prot.id,qty:150}); const veg1=pick('veg'); if(veg1) state.items.push({id:veg1.id,qty:120}); const veg2=pick('veg'); if(veg2 && veg2.id!==veg1?.id) state.items.push({id:veg2.id,qty:120}); const sauce=pick('sauce'); if(sauce) state.items.push({id:sauce.id,qty:25}); renderTable(); genSteps(); }

  // events
  ['category','search','f_gluten','f_soy','f_nuts','f_night','f_no_eggplant'].forEach(id=> byId(id).addEventListener('input', refreshIngSelect));
  byId('ingSelect').addEventListener('dblclick',()=>{ byId('qty').value=100; addSelected(); });
  byId('add').addEventListener('click', addSelected);
  byId('servings').addEventListener('input', updateKPI);
  byId('btnSteps').addEventListener('click', genSteps);
  byId('btnCopy').addEventListener('click', copyText);
  byId('btnExport').addEventListener('click', exportJSON);
  byId('btnPrint').addEventListener('click', printPage);
  byId('btnClear').addEventListener('click', ()=>{ state.items=[]; renderTable(); byId('steps').value=''; });
  byId('btnRandom').addEventListener('click', randomRecipe);
  byId('saveRecipe').addEventListener('click', saveRecipeFromBuilder);

  byId('exportDb').addEventListener('click', exportDB);
  byId('qRecipes').addEventListener('input', renderRecipes);

  byId('saveIng').addEventListener('click', saveIngredient);
  byId('deleteIng').addEventListener('click', deleteIngredient);
  byId('btnImportIng').addEventListener('click', importIngredients);
  byId('btnClearIng').addEventListener('click', clearIngredients);

  byId('btnAddItem').addEventListener('click', addItemFromDB);
  byId('btnSaveRecipe').addEventListener('click', saveRecipeAdmin);
  byId('btnDelRecipe').addEventListener('click', delRecipeAdmin);
  byId('btnExportDB').addEventListener('click', exportDB);
  byId('btnResetDB').addEventListener('click', resetDB);
  byId('btnImportPack').addEventListener('click', importPackFile);

  // init
  (async function init(){ await openDB(); await refreshIngCache(); await refreshRecCache(); renderTable(); })();
})();
</script>
</body></html>
