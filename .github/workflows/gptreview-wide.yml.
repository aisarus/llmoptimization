name: gptreview-wide
on: [pull_request]
jobs:
  review-summary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Summarize SARIF and comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            let sarif = { runs: [] };
            try {
              const sarifPath = path.join(process.cwd(), 'results.sarif');
              sarif = JSON.parse(fs.readFileSync(sarifPath, 'utf8'));
            } catch (err) {
              // If SARIF file is missing or invalid, use empty results
            }
            let critical = 0, major = 0, minor = 0;
            if (sarif.runs) {
              for (const run of sarif.runs) {
                if (run.results) {
                  for (const result of run.results) {
                    let sev = result.level;
                    if (!sev && result.properties) {
                      sev = result.properties.severity || result.properties['problem.severity'];
                    }
                    if (sev) {
                      sev = sev.toString().toLowerCase();
                      if (sev.includes('critical') || sev === 'error' || sev === 'high') {
                        critical++;
                      } else if (sev.includes('major') || sev === 'warning' || sev === 'medium') {
                        major++;
                      } else if (sev.includes('minor') || sev === 'note' || sev === 'low') {
                        minor++;
                      }
                    }
                  }
                }
              }
            }
            const commentBody = `<!-- GPTREVIEW_SUMMARY -->
            **Code Review Summary**

            - Critical: ${critical}
            - Major: ${major}
            - Minor: ${minor}

            \`\`\`mermaid
            pie title Code Review Results
              "Critical" : ${critical}
              "Major" : ${major}
              "Minor" : ${minor}
            \`\`\`

            \`\`\`
            In code's deep waters, we shine a light,
            Fixing bugs through day and night.
            Critical flaws and major concern,
            Each minor fix helps our code to learn.
            \`\`\``;
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner: owner,
              repo: repo,
              issue_number: issue_number
            });
            const marker = '<!-- GPTREVIEW_SUMMARY -->';
            const existing = comments.find(c => c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: owner,
                repo: repo,
                comment_id: existing.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: issue_number,
                body: commentBody
              });
            }
